<?xml version="1.0" encoding="utf-8"?>
<configuration>
	<system.webServer>
		<httpErrors errorMode="Detailed" />
		<staticContent>
			<!-- IIS returns a 404 for extensions it doesn't know about so we have to add webmanifest -->
			<mimeMap fileExtension=".webmanifest" mimeType="application/manifest+json" />
		</staticContent>
		<rewrite>
			<allowedServerVariables>
				<add name="HTTP_ACCEPT_ENCODING" />
			</allowedServerVariables>
			<rules>
				<!--
					A 'hack' for IIS < 1803 (e.g. on Windows Server 2016) to make brotli compression prioritised over gzip.
					See https://docs.microsoft.com/en-us/iis/extensions/iis-compression/using-iis-compression#before-iis-100-version-1803
				-->
				<rule name="Prioritize Brotli">
					<match url=".*" />
					<conditions>
						<add input="{HTTP_ACCEPT_ENCODING}" pattern="\bbr(?!;q=0)\b" />
					</conditions>
					<serverVariables>
						<set name="HTTP_ACCEPT_ENCODING" value="br" />
					</serverVariables>
				</rule>
				<!-- Route static files into the wwwroot folder directly -->
				<rule name="wwwroot-static" stopProcessing="true">
					<match url="(.*\.[^.]+)" />
					<conditions logicalGrouping="MatchAll">
						<add input="{REQUEST_URI}" pattern="^/api" negate="true" />
					</conditions>
					<action type="Rewrite" url="wwwroot/{R:1}" />
				</rule>
				<!-- Route root folders to index.html files -->
				<rule name="wwwroot-index-html" stopProcessing="true">
					<match url="^([^\/]*)\/?$" />
					<conditions>
						<add input="{REQUEST_URI}" pattern="^/api" negate="true" />
					</conditions>
					<action type="Rewrite" url="wwwroot/{R:1}/index.html" />
				</rule>
			</rules>
			<outboundRules>
				<!-- Add cache headers for static files as per Gatsby's static file caching https://www.gatsbyjs.com/docs/caching/ -->
				<rule name="no-cache-static-files" preCondition="is-no-cache-file" stopProcessing="true">
					<match serverVariable="RESPONSE_CACHE-CONTROL" pattern=".*" />
					<action type="Rewrite" value="public,must-revalidate,max-age=30" />
				</rule>
				<rule name="long-cache-static-files" preCondition="is-long-cache-file" stopProcessing="true">
					<match serverVariable="RESPONSE_CACHE-CONTROL" pattern=".*" />
					<action type="Rewrite" value="public,immutable,max-age=31536000" />
				</rule>
				<preConditions>
					<preCondition name="is-no-cache-file" logicalGrouping="MatchAny">
						<add input="{REQUEST_FILENAME}" pattern=".*\.(?:json|html)$" />
						<add input="{REQUEST_FILENAME}" pattern="wwwroot\\sw\.js$" />
					</preCondition>
					<preCondition name="is-long-cache-file" logicalGrouping="MatchAny">
						<add input="{REQUEST_FILENAME}" pattern=".*\.(?:css|js)$" />
						<add input="{REQUEST_FILENAME}" pattern="wwwroot\\static\\.*$" />
					</preCondition>
				</preConditions>
			</outboundRules>
		</rewrite>
		<urlCompression doDynamicCompression="true" doStaticCompression="true" />
		<httpProtocol>
			<customHeaders>
				<remove name="X-Powered-By" />
			</customHeaders>
		</httpProtocol>
		<security>
			<!-- TODO: Reinstate removeServerHeader when we've upgraded to IIS 10 -->
			<!-- <requestFiltering removeServerHeader="true" /> -->
		</security>
		<handlers>
			<add name="StaticFileModuleHtml" path="*.htm*" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
			<add name="StaticFileModuleJs" path="*.js" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
			<add name="StaticFileModuleCss" path="*.css" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
			<add name="StaticFileModulePng" path="*.png" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
			<add name="StaticFileModuleXml" path="*.xml" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
			<add name="StaticFileModuleJson" path="*.json" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
			<add name="StaticFileModuleManifest" path="*.webmanifest" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
			<add name="StaticFileModuleIco" path="*.ico" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
			<add name="StaticFileModuleTxt" path="*.txt" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
			<add name="StaticFileModuleMap" path="*.map" verb="*" modules="StaticFileModule" resourceType="File" requireAccess="Read" />
		</handlers>
	</system.webServer>
</configuration>
